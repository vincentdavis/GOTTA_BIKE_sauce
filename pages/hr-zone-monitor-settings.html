<!DOCTYPE html>
<html class="settings-page" tabindex="0" data-settings-key="hr-zone-monitor-settings-v1">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
        <meta name="apple-mobile-web-app-capable" content="yes"/>
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';"/>

        <title>GOTTA.BIKE sauce - Settings</title>

        <link id="favicon" rel="shortcut icon" href="/pages/images/favicon.png"/>
        <link rel="stylesheet" href="/pages/css/common.css"/>
        <link rel="stylesheet" href="./css/hr-zone-monitor.css"/>
        <link rel="stylesheet" href="./css/event-viewer.css"/>

        <script type="module">
            import {settingsMain} from './src/hr-zone-monitor.mjs';
            settingsMain();
        </script>
    </head>
    <body>
        <div id="titlebar">
            <header>
                <div class="logo"><img src="/pages/images/icon128.png"/></div>
                <div class="title">GOTTA.BIKE sauce</div>
                <div class="filler"></div>
                <div class="buttons">
                    <div title="Close this window" class="button close electron-only"><ms>close</ms></div>
                </div>
            </header>
        </div>

        <div class="tab-navigation">
            <button type="button" class="tab-btn active" data-tab="settings-tab">Settings</button>
            <button type="button" class="tab-btn" data-tab="athletes-tab">Known Athletes</button>
            <button type="button" class="tab-btn" data-tab="zwiftpower-tab">ZwiftPower</button>
            <button type="button" class="tab-btn" data-tab="zwift-tab">Zwift</button>
            <button type="button" class="tab-btn" data-tab="events-tab">Event Viewer</button>
            <button type="button" class="tab-btn" data-tab="help-tab">Help</button>
        </div>

        <div id="settings-tab" class="tab-panel active">
        <div id="settings">
            <form id="options" class="section">
                <div class="title">Display Settings</div>
                <label>
                    <key>Font scaling:</key>
                    <input type="range" name="fontScale" min="0.5" max="3" step="0.1"/>
                    <input type="number" name="fontScale" min="0.5" max="3" step="0.1" style="--size: 5"/>
                </label>
                <label>
                    <key>Max riders to show:</key>
                    <input type="number" name="maxRiders" min="5" max="50" step="1" style="--size: 5"/>
                </label>
                <label>
                    <key>Background:</key>
                    <select name="backgroundOption">
                        <option value="transparent">Transparent</option>
                        <option value="sauce">Sauce Default</option>
                        <option value="black">Black</option>
                        <option value="darkGray">Dark Gray</option>
                        <option value="darkBlue">Dark Blue</option>
                        <option value="darkGreen">Dark Green</option>
                        <option value="custom">Custom Color</option>
                    </select>
                </label>
                <label class="custom-color-row">
                    <key>Custom color:</key>
                    <input type="color" name="customBackgroundColor" value="#232323"/>
                </label>
                <label>
                    <key>Max value mode:</key>
                    <select name="maxValueMode">
                        <option value="session">Session only (reset each ride)</option>
                        <option value="stored">Stored (persist and auto-update)</option>
                    </select>
                </label>
                <label>
                    <key>Theme override:</key>
                    <select is="sauce-theme" override></select>
                </label>
                <label class="filter-checkbox">
                    <input type="checkbox" name="showTeamColumn">
                    <key>Show Team column</key>
                </label>
            </form>

            <form id="power-columns" class="section">
                <div class="title">Power Columns</div>
                <p class="hint">Select which power duration columns to display</p>
                <div class="power-column-options">
                    <label class="filter-checkbox">
                        <input type="checkbox" name="showPower5s">
                        <key>5 sec</key>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" name="showPower15s">
                        <key>15 sec</key>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" name="showPower60s">
                        <key>1 min</key>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" name="showPower300s">
                        <key>5 min</key>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" name="showPower1200s">
                        <key>20 min</key>
                    </label>
                </div>
            </form>

            <form id="draft-columns" class="section">
                <div class="title">Draft Columns</div>
                <p class="hint">Select which draft savings columns to display</p>
                <div class="power-column-options">
                    <label class="filter-checkbox">
                        <input type="checkbox" name="showDraftCur">
                        <key>Current (W)</key>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" name="showDraftAvg">
                        <key>Average (W)</key>
                    </label>
                    <label class="filter-checkbox">
                        <input type="checkbox" name="showDraftEnergy">
                        <key>Energy (kJ)</key>
                    </label>
                </div>
            </form>

            <form id="filter-options" class="section">
                <div class="title">Nearby Athletes</div>
                <label>
                    <key>Sort by:</key>
                    <select name="sortMode">
                        <option value="position">Position</option>
                        <option value="name">Name</option>
                        <option value="team">Team, then Position</option>
                    </select>
                </label>
                <label>
                    <key>Refresh interval:</key>
                    <input type="number" name="refreshInterval" min="1" max="10" step="1" value="2" style="--size: 4"/>
                    <span class="unit">sec</span>
                </label>
                <label>
                    <key>Max gap:</key>
                    <input type="number" name="maxGap" min="5" max="300" step="5" value="60" style="--size: 4"/>
                    <span class="unit">sec</span>
                </label>
                <label class="filter-checkbox">
                    <input type="checkbox" name="filterSameCategory">
                    <key>Only same category</key>
                </label>
                <label class="filter-checkbox">
                    <input type="checkbox" name="filterMarked">
                    <key>Only marked</key>
                </label>
            </form>

            <form id="hr-zone-colors" class="section">
                <div class="title">HR Zone Colors</div>
                <div class="zone-color-grid">
                    <label class="zone-color-row">
                        <span class="zone-label">Zone 1 (&lt;60%)</span>
                        <input type="color" name="hrZone1Color" value="#888888"/>
                        <span class="zone-preview" id="hr-zone1-preview"></span>
                    </label>
                    <label class="zone-color-row">
                        <span class="zone-label">Zone 2 (60-70%)</span>
                        <input type="color" name="hrZone2Color" value="#2196F3"/>
                        <span class="zone-preview" id="hr-zone2-preview"></span>
                    </label>
                    <label class="zone-color-row">
                        <span class="zone-label">Zone 3 (70-80%)</span>
                        <input type="color" name="hrZone3Color" value="#4CAF50"/>
                        <span class="zone-preview" id="hr-zone3-preview"></span>
                    </label>
                    <label class="zone-color-row">
                        <span class="zone-label">Zone 4 (80-90%)</span>
                        <input type="color" name="hrZone4Color" value="#FFEB3B"/>
                        <span class="zone-preview" id="hr-zone4-preview"></span>
                    </label>
                    <label class="zone-color-row">
                        <span class="zone-label">Zone 5 (90%+)</span>
                        <input type="color" name="hrZone5Color" value="#F44336"/>
                        <span class="zone-preview" id="hr-zone5-preview"></span>
                    </label>
                </div>
                <button type="button" id="reset-hr-colors" class="reset-colors-btn">Reset to Defaults</button>
            </form>

            <form id="power-zone-colors" class="section">
                <div class="title">Power Zone Colors</div>
                <div class="zone-color-grid">
                    <label class="zone-color-row">
                        <span class="zone-label">Zone 1 (&lt;60%)</span>
                        <input type="color" name="powerZone1Color" value="#888888"/>
                        <span class="zone-preview" id="power-zone1-preview"></span>
                    </label>
                    <label class="zone-color-row">
                        <span class="zone-label">Zone 2 (60-70%)</span>
                        <input type="color" name="powerZone2Color" value="#2196F3"/>
                        <span class="zone-preview" id="power-zone2-preview"></span>
                    </label>
                    <label class="zone-color-row">
                        <span class="zone-label">Zone 3 (70-80%)</span>
                        <input type="color" name="powerZone3Color" value="#4CAF50"/>
                        <span class="zone-preview" id="power-zone3-preview"></span>
                    </label>
                    <label class="zone-color-row">
                        <span class="zone-label">Zone 4 (80-90%)</span>
                        <input type="color" name="powerZone4Color" value="#FFEB3B"/>
                        <span class="zone-preview" id="power-zone4-preview"></span>
                    </label>
                    <label class="zone-color-row">
                        <span class="zone-label">Zone 5 (90%+)</span>
                        <input type="color" name="powerZone5Color" value="#F44336"/>
                        <span class="zone-preview" id="power-zone5-preview"></span>
                    </label>
                </div>
                <button type="button" id="reset-power-colors" class="reset-colors-btn">Reset to Defaults</button>
            </form>

        </div>
        </div><!-- end #settings-tab -->

        <div id="athletes-tab" class="tab-panel">
            <div class="athletes-content">
                <div class="section">
                    <div class="title">Known Athletes</div>
                    <p class="hint">
                        Max values are automatically tracked during rides and from ZwiftPower imports. Click values to edit.
                    </p>
                    <div class="athlete-search-bar">
                        <input type="text" id="athlete-search" placeholder="Search by name, team, or ID..."/>
                    </div>
                    <div id="athlete-max-list"></div>
                </div>

                <div class="section">
                    <div class="title">Add Athlete Manually</div>
                    <div class="add-rider-form">
                        <input type="text" id="new-rider-name" placeholder="Name (optional)"/>
                        <input type="number" id="new-rider-id" placeholder="Athlete ID" min="1"/>
                        <input type="number" id="new-rider-maxhr" placeholder="Max HR" min="100" max="250"/>
                        <button type="button" id="add-rider-btn">Add</button>
                    </div>
                </div>
            </div>
        </div><!-- end #athletes-tab -->

        <div id="events-tab" class="tab-panel">
            <div id="event-viewer-content">
                <div class="input-section">
                    <input type="text" id="event-input" placeholder="Enter Event ID or Zwift event URL..."/>
                    <button type="button" id="load-event-btn">Load</button>
                </div>

                <div id="cached-events-section">
                    <label for="cached-events">Or select a recent event:</label>
                    <select id="cached-events">
                        <option value="">-- Select Event --</option>
                    </select>
                </div>

                <div id="event-info" hidden>
                    <div class="event-header">
                        <h2 id="event-name"></h2>
                        <div id="event-start"></div>
                    </div>

                    <div class="subgroup-selector">
                        <label for="subgroup-select">Category:</label>
                        <select id="subgroup-select">
                            <option value="">-- Select Category --</option>
                        </select>
                    </div>

                    <div id="subgroup-info" hidden>
                        <div class="subgroup-details">
                            <span class="detail"><strong>Route:</strong> <span id="sg-route"></span></span>
                            <span class="detail"><strong>Distance:</strong> <span id="sg-distance"></span></span>
                            <span class="detail"><strong>Laps:</strong> <span id="sg-laps"></span></span>
                            <span class="detail"><strong>Start:</strong> <span id="sg-start"></span></span>
                        </div>
                    </div>

                    <div id="entrants-section" hidden>
                        <h3>Entrants (<span id="entrant-count">0</span>)</h3>
                        <div class="search-bar">
                            <input type="text" id="entrant-search" placeholder="Search by name..."/>
                        </div>
                        <div id="entrants-list"></div>
                    </div>
                </div>

                <div id="loading" hidden>
                    <div class="spinner"></div>
                    <span>Loading...</span>
                </div>

                <div id="error-message" hidden></div>
            </div>
        </div><!-- end #events-tab -->

        <div id="zwiftpower-tab" class="tab-panel">
            <div class="zwiftpower-content">
                <div class="section">
                    <div class="title">ZwiftPower (zwift.com) Login</div>
                    <p class="hint">Enter your Zwift credentials to fetch athlete data.</p>
                    <div class="zp-credentials">
                        <div class="zp-credential-row">
                            <label for="zp-username">Username:</label>
                            <input type="email" id="zp-username" placeholder="your@email.com" autocomplete="username"/>
                        </div>
                        <div class="zp-credential-row">
                            <label for="zp-password">Password:</label>
                            <input type="password" id="zp-password" placeholder="password" autocomplete="current-password"/>
                        </div>
                        <div class="zp-credentials-actions">
                            <button type="button" id="zp-save-credentials">Save</button>
                            <span id="zp-credentials-status"></span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="title">Fetch Athlete Data <span id="zp-server-status" class="zp-server-status offline">â—‹ Server not running</span></div>
                    <p class="hint">Enter an athlete ID to fetch their ZwiftPower profile.</p>
                    <div class="zp-fetch-section">
                        <input type="number" id="zp-fetch-athlete-id" placeholder="Athlete ID" min="1"/>
                        <button type="button" id="zp-fetch-btn">Fetch & Import</button>
                    </div>
                    <div id="zp-fetch-status" class="zp-fetch-status"></div>
                </div>

                <div class="section">
                    <div class="title">Manual Import</div>
                    <p class="hint">Or import a previously downloaded JSON file.</p>
                    <div class="zp-import-section">
                        <label class="zp-file-label">
                            <input type="file" id="zp-file-input" accept=".json,application/json"/>
                            <span class="zp-file-btn">Choose JSON File</span>
                        </label>
                        <span id="zp-file-name"></span>
                    </div>
                    <div class="zp-lookup-section">
                        <input type="number" id="zp-athlete-id" placeholder="Athlete ID" min="1"/>
                        <button type="button" id="zp-import-file-btn">Import</button>
                    </div>
                    <div id="zp-lookup-loading" hidden>
                        <div class="spinner"></div>
                        <span>Processing...</span>
                    </div>
                    <div id="zp-lookup-error" hidden></div>
                </div>

                <div class="section" id="zp-profile-section" hidden>
                    <div class="title">Profile Data</div>
                    <div id="zp-profile-display"></div>
                </div>

                <div class="section">
                    <div class="title">Start Fetch Server</div>
                    <div class="zp-info">
                        <p>Run this command in a terminal to enable fetching:</p>
                        <pre class="zp-code">cd /path/to/mod/scripts && node zp-fetch.mjs --server</pre>
                        <p class="hint">The status indicator above will turn green when connected.</p>
                    </div>
                </div>

                <div class="section">
                    <div class="title">About ZwiftPower Data</div>
                    <div class="zp-info">
                        <p>The import extracts <strong>best power values from the last 60 days</strong> and <strong>average of top 3 max heart rates</strong>.</p>
                    </div>
                </div>
            </div>
        </div><!-- end #zwiftpower-tab -->

        <div id="zwift-tab" class="tab-panel">
            <div class="zwift-content">
                <div class="section">
                    <div class="title">Zwift</div>
                    <p class="hint">Zwift-related features and settings.</p>
                </div>
            </div>
        </div><!-- end #zwift-tab -->

        <div id="help-tab" class="tab-panel">
            <div class="help-content">
                <div class="section">
                    <div class="title">About GOTTA.BIKE sauce</div>
                    <p>A Sauce4Zwift mod that displays nearby riders with heart rate and power data color-coded by training zones.</p>
                </div>

                <div class="section">
                    <div class="title">Main Window</div>
                    <p>The main overlay shows nearby riders with:</p>
                    <ul>
                        <li><strong>Rider Name</strong> - Click a row to set max HR</li>
                        <li><strong>%HR</strong> - Heart rate as percentage of max HR, color-coded by zone</li>
                        <li><strong>Power Columns</strong> - Smoothed power as percentage of max, color-coded</li>
                        <li><strong>Draft Columns</strong> - Draft savings in watts or energy saved in kJ</li>
                    </ul>
                </div>

                <div class="section">
                    <div class="title">HR &amp; Power Zones</div>
                    <p>Both HR and power use the same zone thresholds:</p>
                    <ul>
                        <li><span class="zone-sample" style="background:#888888;">Gray</span> - Below 60% (Recovery)</li>
                        <li><span class="zone-sample" style="background:#2196F3;">Blue</span> - 60-70% (Endurance)</li>
                        <li><span class="zone-sample" style="background:#4CAF50;">Green</span> - 70-80% (Tempo)</li>
                        <li><span class="zone-sample" style="background:#FFEB3B;color:#000;">Yellow</span> - 80-90% (Threshold)</li>
                        <li><span class="zone-sample" style="background:#F44336;">Red</span> - 90%+ (VO2 Max)</li>
                    </ul>
                </div>

                <div class="section">
                    <div class="title">Max Value Modes</div>
                    <ul>
                        <li><strong>Session only</strong> - Max values reset each ride. Good for seeing current session peaks.</li>
                        <li><strong>Stored</strong> - Max values persist and auto-update, as observed during ride. Better for tracking athletes over time. You can also maualy edit the values</li>
                    </ul>
                </div>

                <div class="section">
                    <div class="title">Event Viewer</div>
                    <p>Look up Zwift events by ID or URL to see entrants and set their max values before a race:</p>
                    <ul>
                        <li>Enter an event ID (e.g., <code>1234567</code>)</li>
                        <li>Or paste a Zwift event URL</li>
                        <li>Select a category to see entrants</li>
                        <li>Edit max HR, power, and team values for each athlete</li>
                    </ul>
                </div>

                <div class="section">
                    <div class="title">Filters</div>
                    <p>Use filters to show specific riders. When multiple filters are enabled, riders matching ANY filter are shown (OR logic):</p>
                    <ul>
                        <li><strong>Show All</strong> - Disables all filters</li>
                        <li><strong>Only with HR</strong> - Riders broadcasting heart rate</li>
                        <li><strong>In My Group</strong> - Riders within ~3 seconds gap</li>
                        <li><strong>Marked/Following</strong> - Riders you've marked or follow</li>
                        <li><strong>Same Event</strong> - Riders in same event subgroup</li>
                        <li><strong>By Team</strong> - Filter by team name</li>
                    </ul>
                </div>

                <div class="section">
                    <div class="title">Tips</div>
                    <ul>
                        <li>Click any rider row in the main window to quickly set their max HR</li>
                        <li>Use Event Viewer before a race to pre-populate competitor data</li>
                        <li>Team names are saved with athlete data for easy identification</li>
                        <li>Draft columns show watts saved from drafting - useful for group rides</li>
                    </ul>
                </div>

                <div class="section">
                    <div class="title">Links</div>
                    <p>
                        <a href="https://gotta.bike" target="_blank">gotta.bike</a>
                    </p>
                </div>
            </div>
        </div><!-- end #help-tab -->
    </body>
</html>
